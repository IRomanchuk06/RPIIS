# Лабораторная работа №1


## Вариант 35
Условие:
> На вход пакетному файлу приходит путь к каталогу (как параметр пакетного файла). Если такой папки нет, то писать “Данной папки нет” и завершить выполнение программы. Если такая папка есть, то найти в заданном каталоге и всех его подкаталогах все файлы заданного размера и принадлежащие определённому пользователю. Диапазон (min - max) размеров файлов задаётся пользователем в качестве второго и третьего параметра пакетного файла. Имя владельца задаётся пользователем в качестве четвёртого параметра пакетного файла. Скрипт выводит результаты поиска в файл в виде "полный путь, имя файла, его размер", в конец файла выводится общее число просмотренных файлов.

## Параметры запуска
1. Путь к папке, с которой будет вестись работа.
2. Минимально допустимый размер файла в папке.
3. Максимально допустимый размер файла в папке.
4. Какой должен быть у файла владелец.

## Краткое словесное описание алгоритма
1. Пользователь одновременно с запуском скрипта вводит 4 указанных выше параметра.
2. Проверка на существование папки, указанной в первом параметре.
   - Если папка не существует, программа завершает свою работу.
3. Проход по папке и её подпапкам.
4. Вывод полного и краткого имени, а также размера тех файлов в папке и её подпапках, которые удовлетворяют следующим условиям:
   - Размер находится в диапазоне, заданном во втором и третьем параметрах;
   - Владелец файла совпадает с указанным в четвёртом параметре.

## Подробное описание кода
### CMD
Полный код:
```batchfile
@echo off
chcp 65001 >nul
setlocal EnableDelayedExpansion

if not exist %1%\ (
echo Данной папки нет
pause

) else (

for /f "delims=" %%i in ('dir /a-d/b/s %1') do (

PowerShell.Exe -executionpolicy bypass -File "findowner.ps1" "%%i" >op.tmp
set /p owner=<op.tmp
del op.tmp

if %%~zi leq %3 if %%~zi geq %2 if "!owner!" equ "%4" echo %%i %%~nxi %%~zi>con)

set ff=0 & for /f "delims=" %%i in ('dir /a-d/b/s %1') do @(set /a ff+=1 >nul)

echo Всего файлов прочитано: !ff! && set "ff="
pause
)
```
		
Вспомогательный алгоритм findowner.ps1:
```powershell
param ($thefile)
(Get-Acl $thefile).Owner
```

Используемые переменные:
- %1, %2, %3, %4 - параметры 1-4 (см. "Параметры запуска")
- %%i - путь к рассматриваемому файлу в цикле (его полное имя)
- %%zi - размер рассматриваемого файла в цикле
- %%nxi - краткое имя рассматриваемого файла в цикле
- owner - владелец рассматриваемого файла в цикле
- ff - общее количество файлов в папке (%1) и её подпапках

```batchfile
@echo off
```
\- отключение отображения выполняемых команд на экране.

```batchfile
chcp 65001 >nul
```
\- перевод рабочей кодовой страницы на UTF-8.

```batchfile
setlocal EnableDelayedExpansion
```
\- переменные будут обрабатываться по мере выполнения скрипта, что обеспечит корректную работу с ними.

```batchfile
if not exist %1%\ (
echo Данной папки нет
pause
)
```
\- если папки, указанной в первом параметре, не существует, скрипт выводит "Данной папки нет" и ожидает нажатия клавиши пользователем перед своим закрытием.

```batchfile
else (
```
\- все последующие команды выполняются лишь если предыдущее условие неверно (т.е. папка, введённая в качестве первого параметра, существует).

```batchfile
for /f "delims=" %%i in ('dir /a-d/b/s %1') do (
```
\- проход по файлам (\/a-d) в папке из первого параметра и её подпапках (\/s), причём для дальнейшей работы используются только названия файлов без подробного описания каждого из них (\/b).

```batchfile
PowerShell.Exe -executionpolicy bypass -File "findowner.ps1" "%%i" >op.tmp
```
\- запуск вспомогательного скрипта PowerShell "findowner.ps1", определяющего владельца рассматриваемого файла, и вывод результата выполнения данного вспомогательного скрипта во временный файл "op.tmp".

```batchfile
set /p owner=<op.tmp
del op.tmp
```
\- объявление переменной "owner", хранящей владельца рассматриваемого файла, присвоение ей результата из файла "op.tmp". После - удаление данного файла.

```batchfile
if %%~zi leq %3 if %%~zi geq %2 if "!owner!" equ "%4"
```
\- если размер рассматриваемого файла (в байтах) не более указанного в третьем параметре и не менее указанного во втором параметре, а также у него нужный владелец (заданный в четвёртом параметре)...

```batchfile
echo %%i %%~nxi %%~zi>con)
```
\- путь к файлу (полное имя файла), краткое имя файла и его размер в байтах выводятся на экран (>con).

```batchfile
set ff=0
```
\- объявление переменной "ff", служащей счётчиком количества всех файлов в папке (параметр 1) и её подпапках.

```batchfile
for /f "delims=" %%i in ('dir /a-d/b/s %1') do @(set /a ff+=1 >nul)
```
\- подсчёт количества **всех** файлов в папке (параметр 1) и её подпапках, производимый при помощи увеличения переменной "ff" на 1 при просмотре каждого файла.

```batchfile
echo Всего файлов прочитано: !ff! && set "ff="
pause
)
```
\- вывод общего количества файлов в папке (параметр 1) и её подпапках, записанного в переменной "ff", очистка переменной "ff" во избежание ошибок. Затем - ожидание скриптом нажатия клавиши, после чего он завершает свою работу. 


### Shell
Полный код:
```shell
#!bin/bash

if ! test -d "$1"
then
	echo Данной папки нет

else
	count=0
			
	if test -d $1/**/
	then
		for file in $1/*.* $1/**/*.*
		do
			let count=count+1
			
			fsize=`cat $file | wc -c`
			fuser=`stat --format '%U' $file`
					
			if [[ $fsize -le $3 && $fsize -ge $2 && $4=$fuser ]]
			then
				echo $file `basename $file` $fsize
			fi
		done
	
	else
		for file in $1/*.*
		do
			let count=count+1
			
			fsize=`cat $file | wc -c`
			fuser=`stat --format '%U' $file`
			
			if [[ $fsize -le $3 && $fsize -ge $2 && "$4"="$fuser" ]]
			then
				echo $file `basename $file` $fsize
			fi
		done
	fi
			
	echo Всего файлов прочитано: $count
fi
```

Используемые переменные:
- $1, $2, $3, $4 - параметры 1-4 (см. "Параметры запуска")
- $file - путь к рассматриваемому файлу в цикле (его полное имя)
- $fsize - размер рассматриваемого файла в цикле
- $fuser - владелец рассматриваемого файла в цикле
- $count - общее количество файлов в папке ($1) и её подпапках

```shell
#!bin/bash
```
\- обозначение, что для работы используется Bash.

```shell
if ! test -d "$1"
then
	echo Данной папки нет
```
\- если папки, данной в параметре 1, не существует, сообщить об этом пользователю и не выполнять дальнейших действий.

```shell
else
```
\- все дальнейшие команды выполняются лишь если вышеуказанное условие неверно (т.е. папка в параметре 1 существует).

```shell
count=0
```
\- объявление переменной "count", служащей счётчиком количества файлов в папке (параметр 1) и её подпапках (если они есть).

```shell
if test -d $1/**/
```
\- если у папки (параметр 1) есть подпапки...

```shell
for file in $1/*.* $1/**/*.*
```
\- ...произвести проход по файлам в папке (параметр 1) и её подпапкам.

```shell
else
	for file in $1/*.*
```
\- если у папки (параметр 1) подпапок нет, произвести проход по файлам только в папке (параметр 1) во избежание ошибок.

```shell
let count=count+1
```
\- при рассмотрении каждого файла увеличить счётчик общего количества файлов на 1.

```shell
fsize=`cat $file | wc -c`
```
\- запись размера (в байтах) рассматриваемого файла в переменную "fsize".

```shell
fuser=`stat --format '%U' $file`
```
\- запись имени владельца рассматриваемого файла в переменную "fuser".

```shell
if [[ $fsize -le $3 && $fsize -ge $2 && $4=$fuser ]]
then
	echo $file `basename $file` $fsize
fi
```
\- если размер (в байтах) рассматриваемого файла не более указанного в третьем параметре и не менее указанного во втором параметре, а также у него нужный владелец (заданный в четвёртом параметре), вывести на экран путь к файлу, краткое имя файла и его размер в байтах.

```shell
echo Всего файлов прочитано: $count
```
\- вывод на экран общего количества файлов в папке (параметр 1) и её подпапках (если они есть).


## Пример запуска
Дана следующая папка:

![Изображение папки](img/test_folder.png)
![Изображение подпапки](img/test_subfolder.png)

Запуск команды с путём к этой папке в качестве параметра:

![Изображение команды (bat)](img/test_command_bat.png)

![Изображение команды (sh)](img/test_command_sh.png)
